<?php

	require("./init.php");

	if (!session_is_registered("userid")){
		$template->assign("loginerror", 0);
		$template->display("template_login.tpl");
		die();
	}
		
	if ($adminstate < 4) {
	    $errtxt = $langfile["general_nopermission"];
	    $noperm = $langfile["general_accessdenied"];
	    $template->assign("errortext", "$errtxt<br>$noperm");
	    $template->display("template_error.tpl");
	    die();
	}

	$action = getArrayVal($_GET, "action");
	$id = getArrayVal($_GET, "id");
	$mode = getArrayVal($_GET, "mode");
	// SEARCH
	$type = getArrayVal($_POST, "type");
	$value = utf8_decode(trim(getArrayVal($_POST, "value")));
	$limit = getArrayVal($_POST, "limit");
	
	$mainclasses = array("user" => "user", "management_current" => "management", "management_no_current" => "management_active", "admin" => "admin", "logout" => "logout");
	$template->assign("mainclasses", $mainclasses);
	
	$mainmenu = array("user" => "active");
	$template->assign("mainmenu", $mainmenu);

	// open/reduce workspace
	if (getArrayVal($_COOKIE, "workspacecookie")) {
	    $workspaceclass = $_COOKIE['workspacecookie'];
		$template->assign("workspaceclass", $workspaceclass);
	} else {
	    $workspaceclass = "";
		$template->assign("workspaceclass", $workspaceclass);
	}
	
	$user = new user();
	$speciality = new speciality();
	$mylog = (object) new mylog();
	
	switch ($action) {

	    case "add":
			$title = $langfile['navigation_title_management_user_add'];
    		$languages_fin = array();
		    foreach($languages as $lang) {
	        $lang2 = $langfile[$lang];
	        $fin = countLanguageStrings($lang);
	
	        if (!empty($lang2))
	        {
	            $lang2 .= " (" . $fin . "%)";
	            $fin = array("val" => $lang, "str" => $lang2);
	        }
	        else
	        {
	            $lang2 = $lang . " (" . $fin . "%)";
	            $fin = array("val" => $lang, "str" => $lang2);
	        }
	        array_push($languages_fin, $fin);
	    }
	    $specialities = $speciality->getall();
	    
	    $template->assign("title", $title);
	    $template->assign("languages_fin", $languages_fin);
		$template->assign("specialities", $specialities);
	    
	    $template->display("template_management_user_edit.tpl");
    		
	    break;
	    	
	    case "edit":
			$title = $langfile['navigation_title_management_user_edit'];
    		$languages_fin = array();
		    foreach($languages as $lang) {
	        $lang2 = $langfile[$lang];
	        $fin = countLanguageStrings($lang);
	
	        if (!empty($lang2))
	        {
	            $lang2 .= " (" . $fin . "%)";
	            $fin = array("val" => $lang, "str" => $lang2);
	        }
	        else
	        {
	            $lang2 = $lang . " (" . $fin . "%)";
	            $fin = array("val" => $lang, "str" => $lang2);
	        }
	        array_push($languages_fin, $fin);
	    }
	    $user = $user->getProfile($id);
	    $specialities = $speciality->getall();
	    
	    $template->assign("title", $title);
	    $template->assign("languages_fin", $languages_fin);
	    $template->assign("user", $user);
		$template->assign("specialities", $specialities);
	    
	    $template->display("template_management_user_edit.tpl");
    		
	    break;

		case "submit":
		
			$id = getArrayVal($_POST, "id");
			$firstname = getArrayVal($_POST, "firstname");
			$familyname  = getArrayVal($_POST, "familyname");
			$birthday = getArrayVal($_POST, "birthday");
			$gender = getArrayVal($_POST, "gender");
			$locale  = getArrayVal($_POST, "locale");
			$address1 = getArrayVal($_POST, "address1");
			$zip1city1 = getArrayVal($_POST, "zip1city1");
			$zip1 = substr($zip1city1,0,4);
			$city1 = trim(substr($zip1city1,4));
			$state1 = getArrayVal($_POST, "state1");
			$country1 = getArrayVal($_POST, "country1");
			$company  = getArrayVal($_POST, "company");
			$workphone = getArrayVal($_POST, "workphone");
			$privatephone = getArrayVal($_POST, "privatephone");
			$mobilephone = getArrayVal($_POST, "mobilephone");
			$fax = getArrayVal($_POST, "fax");
			$email = getArrayVal($_POST, "email");
			$web = getArrayVal($_POST, "web");
			$type = getArrayVal($_POST, "type");
			$speciality = getArrayVal($_POST, "speciality");
			$inami = getArrayVal($_POST, "inami");
			
		    $_SESSION['userlocale'] = $locale;
		    $_SESSION['username'] = $name;
		    
			if ($id != '') {
				
				$user->manager_submit($id, $firstname, $familyname, $birthday, $gender, $email, $web, $company, $address1, $zip1, $city1, $state1, $country1, $workphone, $privatephone, $mobilephone, $fax, $type, $speciality, $inami);
	        	$action = $firstname.' '.$familyname;
	        	$mylog->add('user','add',$action);
				$loc = $url . "management_user.php?action=detail&id=$id&mode=edited";
	            header("Location: $loc");
				
			} else {
				
				$user = $user->manager_add($firstname, $familyname, $birthday, $gender, $email, $web, $company, $address1, $zip1, $city1, $state1, $country1, $workphone, $privatephone, $mobilephone, $fax, $type, $speciality, $inami);
				$action = $firstname.' '.$familyname;
	        	$mylog->add('user','update',$action);
				$loc = $url . "management_user.php?action=detail&id=$user&mode=added";
	            header("Location: $loc");
				
	        }
	    
		break;
	
	
		case "list":
			
			$right0 = $langfile["dico_admin_people_user_no_login"];
			$right1 = $langfile["dico_admin_people_user_user"];
			$right3 = $langfile["dico_admin_people_user_manager"];
			$right4 = $langfile["dico_admin_people_user_manager_advanced"];
			$right5 = $langfile["dico_admin_people_user_admin"];
			
			$edit_alt = $langfile["dico_admin_people_user_edit_alt"];
			$detail_alt = $langfile["dico_admin_people_user_detail_alt"];
		
			$detail1 = "<a onclick=\"javascript=viewUser(";
			$detail2 = ",\'management_user.php\')\" ><img width=\"16\" height=\"16\" src=\"./templates/standard/images/butn-view-hover.png\" alt=\"".$detail_alt."\" title=\"".$detail_alt."\" border=\"0\" /></a>";
			
			$edit1 = "<a onclick=\"javascript=editUser(";
			$edit2 = ",\'management_user.php\')\" ><img width=\"16\" height=\"16\" src=\"./templates/standard/images/butn-edit-hover.png\" alt=\"".$edit_alt."\" title=\"".$edit_alt."\" border=\"0\" /></a>";
			
			$authenificate1 = "<input type=\'checkbox\' ";
			$authenificate2 = " disabled=\'true\' />";
			
			$sql = "SELECT concat('$edit1',ID,'$edit2',' ','$detail1',ID,'$detail2'), name, firstname, familyname, concat(address1,' ',zip1,' ',city1), email, REPLACE(REPLACE(REPLACE(REPLACE(REPLACE( admin, '0', '$right0' ),'1','$right1'),'3','$right3'),'4','$right4'),'5','$right5'), speciality, inami FROM user ORDER BY familyname, firstname WHERE ID!='0'";
				
			$_SESSION['userlist']=$sql;
			
			$title = $langfile["navigation_title_management_user_list"];
	
			$template->assign("title", $title);
			$template->assign("workspaceclass", "fullpage");
			
			$template->display("template_management_user_list.tpl");
			
		break;
		
		case "modulesearch":

			$users = $user->modulesearch($id,$value,$limit);
			$template->assign("users", $users);

			if ($type == 'complete') {
				$template->display("template_management_gestion_complete_search.tpl");
			} else {
				$template->display("template_management_gestion_simple_search.tpl");
			}
			
			break;
			
		case "autocomplete":
			
			$user->autocomplete($id,$value);
			
			break;

		case "detail":
		
			$profile = $user->getProfile($id);
	    	$template->assign("mode", $mode);
			$template->assign("user", $profile);
			$template->display("template_management_user_detail.tpl");
		
			break;
			
		default:
	    	$title = $langfile["navigation_title_management_user_search"];
	
			$template->assign("title", $title);

			$template->display("template_management_user_search.tpl");
	}

?>